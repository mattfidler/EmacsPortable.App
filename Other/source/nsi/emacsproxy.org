#+TITLE: Shared Proxy Code
#+AUTHOR: Matthew L. Fidler
#+PROPERTY: tangle emacsproxy.nsh
* Proxy
** Variables
#+BEGIN_SRC nsis
  Var PROXY_ID
  Var PROXY_IDE
  Var PROXY_NAME
  Var PROXY_SERVER
  Var PROXY_PORT
  Var PROXY_USER
  Var PROXY_PASS
#+END_SRC

** Read Line Function 
#+BEGIN_SRC nsis
  Function ReadFileLine
    Exch $0 ;file
    Exch
    Exch $1 ;line number
    Push $2
    Push $3
    
    FileOpen $2 $0 r
    StrCpy $3 0
    
    Loop:
      IntOp $3 $3 + 1
      ClearErrors
      FileRead $2 $0
      IfErrors +2
      StrCmp $3 $1 0 loop
      FileClose $2
      
      Pop $3
      Pop $2
      Pop $1
      Exch $0
  FunctionEnd
#+END_SRC

** Setup Proxy
#+BEGIN_SRC nsis
  Function IPAddressesCallback
    Pop $5
    StrCpy $6 $5 "" -1
    StrCmp "$6" "." +3
    StrCpy $5 $5 -1
    Goto -3
    StrCpy $5 $5 -1
    StrCpy $PROXY_IDE "$PROXY_IDE$5"
    StrCpy $PROXY_ID "$PROXY_ID$5"
    end:
      ClearErrors
  FunctionEnd
  
  
  Function SetupProxy
    Pop $9
    StrCpy $PROXY_IDE ""
    StrCpy $PROXY_ID ""
    StrCpy $R0 "grep"
    IfFileExists "$EXEDIR\App\gw32\bin\grep.exe" 0 +3
    StrCpy $R0 "$EXEDIR\App\gw32\bin\grep.exe" 
    Goto +3
    IfFileExists "$EXEDIR\App\ezwin\bin\grep.exe" 0 +2
    StrCpy $R0 "$EXEDIR\App\ezwin\bin\grep.exe"
    ExecDos::exec "cmd /c $\"ipconfig | $R0 $\"IP A$\" > $TEMP\ep\ep-ip.txt$\""
    IfFileExists "$TEMP\ep\ep-ip.txt" 0 proxy_setup
    
    IfFileExists "$EXEDIR\App\gw32\bin\sed.exe" 0 +3
    StrCpy $R0 "$EXEDIR\App\gw32\bin\sed.exe" 
    Goto +3
    IfFileExists "$EXEDIR\App\ezwin\bin\sed.exe" 0 +2
    StrCpy $R0 "$EXEDIR\App\ezwin\bin\sed.exe"
    FileOpen $4 "$TEMP\ep\ep-sed-ip.bat" w
    IfErrors proxy_setup
    FileWrite $4 "@$R0 -r $\"s/[^0-9]*([0-9]*[0-9.]+).*/\1/$\" $TEMP\ep\ep-ip.txt > $TEMP\ep\ep-ip2.txt$\r$\n"
    FileClose $4 
    ExecDos::exec "cmd /c $\"$TEMP\ep\ep-sed-ip.bat$\""
    Delete "$TEMP\ep\ep-sed-ip.bat"
    Delete "$TEMP\ep\ep-ip.txt"
  
    read_ips:
      FileOpen $4 "$TEMP\ep\ep-ip2.txt" r
      IfErrors 0 +3
      FileClose $4
      Goto proxy_setup
  
      FileRead $4 $1
  
      StrCpy $1 $1  -1
  
      IfErrors 0 +3
      FileClose $4
      goto proxy_setup
  
      execDos::exec  "cmd /c $\"nslookup $1 > $TEMP\ep\ep-dns.txt$\""
      
      FileOpen $5 "$TEMP\ep\ep-dns.txt" r
      FileRead $5 $R0
      IfErrors 0 +2
      ClearErrors
      FileClose $5
      StrCpy $R0 $R0 "" 9
      StrCpy $R0 $R0 -2
      StrCpy $PROXY_IDE "$R0"
      StrCpy $PROXY_ID "$PROXY_ID$R0"
      Delete "$TEMP\ep\ep-dns.txt"

    proxy_setup:
      ClearErrors
      StrCmp "$PROXY_ID" "" 0 +2
      StrCpy $PROXY_ID "Unknown"
      StrCpy $PROXY_NAME $PROXY_ID
      StrCpy $PROXY_ID "$PROXY_ID mmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmm"
      IfFileExists "$9\proxy-$PROXY_IDE.ini" 0 end
      ReadIniStr $R0 "$9\proxy-$PROXY_IDE.ini" "$PROXY_NAME" "Server"
      blowfish::decrypt $R0 "$PROXY_ID"
      Pop $R0
      Pop $R0
      StrCpy "$PROXY_SERVER" "$R0"
      StrCmp "$R0" "" end
      StrCpy "$R1" "$R0"
      ReadIniStr "$R0" "$9\proxy-$PROXY_IDE.ini" "$PROXY_NAME" "Port"
      blowfish::decrypt $R0 "$PROXY_ID"
      Pop $R0
      Pop $R0
      StrCpy "$PROXY_PORT" "$R0"  
      StrCmp "$R0" "" +2 0
      StrCpy "$R1" "$R1:$R0"
      ReadIniStr "$R0" "$9\proxy-$PROXY_IDE.ini" "$PROXY_NAME" "User"
      blowfish::decrypt $R0 "$PROXY_ID"
      Pop $R0
      Pop $R0
      StrCpy $PROXY_USER "$R0"
      
      StrCmp "$R0" "" +2 0
      StrCpy "$R2" "$R0"
      ReadIniStr "$R0" "$9\proxy-$PROXY_IDE.ini" "$PROXY_NAME" "Password"
      blowfish::decrypt $R0 "$PROXY_ID"
      Pop $R0
      Pop $R0
      StrCpy $PROXY_PASS $R0
      StrCmp "$R0" "" +3 0
      StrCmp "$R2" "" +2 0
      StrCpy "$R2" "$R2:$R0"
      StrCmp "$R2" "" +2 0
      StrCpy "$R1" "$R2@$R1"
      System::Call 'Kernel32::SetEnvironmentVariableA(t, t) i("HTTP_PROXY","http://$R1").r0'
      System::Call 'Kernel32::SetEnvironmentVariableA(t, t) i("HTTPS_PROXY","http://$R1").r0'
      System::Call 'Kernel32::SetEnvironmentVariableA(t, t) i("FTP_PROXY","ftp://$R1").r0'
    end:
      ClearErrors
  FunctionEnd
  
  !macro SetupProxy FILE
    Push "${FILE}"
    Call SetupProxy
    Pop $R0
  !macroend
  
  !define SetupProxy `!insertmacro SetupProxy "$EXEDIR\Data\ini\"`
  !define SetupProxyFile `!insertmacro SetupProxy`
  
#+END_SRC
