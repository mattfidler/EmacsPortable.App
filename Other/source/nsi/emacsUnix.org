#+TITLE: Unix Tools Download
#+AUTHOR: Matthew L. Fidler
#+PROPERTY: tangle EmacsUnix.nsi
* Introduction
This is a dialog to change which Unix utilities will be downloaded.
* Installer Properties
** Setup Options
I want:
 - user level execution
 - CRC check
 - Good compression
 - Automatic closing.
#+BEGIN_SRC nsis
CRCCheck On
RequestExecutionLevel user
; Best Compression
SetCompress Auto
SetCompressor /SOLID lzma
SetCompressorDictSize 32
SetDatablockOptimize On
AutoCloseWindow true
#+END_SRC

** User Interface
Modern UI2 user interface
#+BEGIN_SRC nsis
!include "MUI2.nsh"
!include "EmacsDownloadShared.nsh"
var EPEXE
#+END_SRC
** Defines
#+BEGIN_SRC nsis
!define mirror $EPEXE\App\ini\mirrors.ini
#+END_SRC
** Headers and Plugins
#+BEGIN_SRC nsis
  !include "FileFunc.nsh"
  !include "nsDialogs.nsh"
#+END_SRC
** Output Executable
#+BEGIN_SRC nsis
OutFile "..\..\..\App\eps\download-unix.exe"
#+END_SRC

** Modern UI interface setup
#+BEGIN_SRC nsis
  Name "EmacsPortable.App Download Emacs"
  BrandingText "EmacsPortable.App"
  !define MUI_ICON "..\img\ico\preferences_system.ico"
  !define MUI_HEADERIMAGE
  
  !define MUI_HEADERIMAGE_BITMAP "..\img\headerimage-options.bmp" ; 150x57 pixels
  !define MUI_HEADERIMAGE_UNBITMAP "..\img\headerimage-options.bmp" ; 150x57 pixels
  
  !define MUI_WELCOMEFINISHPAGE_BITMAP "..\img\welcome-options.bmp" ;164x314 pixels
  !define MUI_UNWELCOMEFINISHPAGE_BITMAP "..\img\welcome-options.bmp" ;164x314 pixels
  
  !define MUI_ABORTWARNING
  !define MUI_UNABORTWARNING
  !define MUI_PAGE_HEADER_TEXT "EmacsPortable.app"
  !define MUI_PAGE_HEADER_SUBTEXT "Emacs on the Go"
  
  !define MUI_COMPONENTSPAGE_SMALLDESC
  !define MUI_HEADERIMAGE_RIGHT
  !insertmacro MUI_PAGE_COMPONENTS
  !insertmacro MUI_PAGE_INSTFILES
  #!insertmacro MUI_PAGE_FINISH
  !insertmacro MUI_LANGUAGE "English"
#+END_SRC
* Sections
** Lisp-generated sections
#+BEGIN_SRC nsis
  SectionGroup "Add Unix Programs" sec_add_unix_programs ; Collapsed
    ; Description:
    ; These are unix programs you can use to support EmacsPortable.App
    !include "emacsdownload-gw32.nsi"
    !include "emacsdownload-ezwin.nsi"
    !insertmacro InsertAddEZW
  SectionGroupEnd ; sec_add_unix_program
  
  SectionGroup "Remove Installed Unix Programs" sec_remove_installed_unix_programs ; Collapsed
    ; Description:
    ; Remove Installed Unix Programs
    !include "emacsdownload-rgw32.nsi"
    !include "emacsdownload-rezwin.nsi"
  SectionGroupEnd ; sec_remove_installed_unix_programss
  
  
#+END_SRC
** Section Descriptions 
#+BEGIN_SRC nsis
  ;--------------------------------
  ;Description(s)
  LangString DESC_sec_add_unix_programs ${LANG_ENGLISH} "These are unix programs you can use to support EmacsPortable.App"
  LangString DESC_sec_remove_installed_unix_programs ${LANG_ENGLISH} "Remove Installed Unix Programs"
  
  !insertmacro MUI_FUNCTION_DESCRIPTION_BEGIN
    !insertmacro MUI_DESCRIPTION_TEXT ${sec_remove_installed_unix_programs} $(DESC_sec_remove_installed_unix_programs)
    !insertmacro MUI_DESCRIPTION_TEXT ${sec_add_unix_programs} $(DESC_sec_add_unix_programs)
    
    ${GW32_DESC}
    ${GW32E_DESC}
    ${RGW32_DESC}
    ${EZWIN_DESC}
    ${EZWINE_DESC}
    ${REZWIN_DESC}
  !insertmacro MUI_FUNCTION_DESCRIPTION_END
#+END_SRC
* Functions
** Initialization
#+BEGIN_SRC nsis
  Function .onInit
    IfFileExists "..\..\EmacsPortableApp.exe" 0 +3
    GetFullPathName /SHORT $EPEXE "..\.."
    Goto +2
    ReadINIStr $EPEXE "$EXEDIR\ep.ini" "EmacsPortableApp" "EXEDIR"
  
    IfFileExists "..\..\EmacsPortableApp.exe" 0 +3
    GetFullPathName /SHORT $INSTDIR "..\.."
    Goto +2
    ReadINIStr $INSTDIR "$EXEDIR\ep.ini" "EmacsPortableApp" "EXEDIR"
    ClearErrors
    SetOutPath "$TEMP\ep"
    Delete "$TEMP\ep\unix-download.ini"
    ${G32_INI}
    ${EZWIN_INI}
    ${RREZWIN_INI}
    ${RG32_INI}
  FunctionEnd
#+END_SRC
